<!doctype html>
<html>
<head>
<title></title>
<meta charset="UTF-8">
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="author" content="Ed Dickinson">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="">
<link rel="stylesheet" type="text/css" href="css.css"/>
<style>



</style>

</head>
<body>

<main>
  <h1>Symbular</h1>
  <div id="the-grid">

  </div>
  <div id="readout">
    readout:
    <div>
      <div>
        master: <span class="master">I</span>
      </div>
      <div>
        volume: <span class="volume">9</span>
      </div>
      <div>
        key: <span class="key-note">C</span> <span class="key-mode">maj</span>
      </div>

    </div>

<button id="play-button">Play/Pause</button>
<!-- <script src="music.js"></script> -->

<input type="range" min="1" max="100" value="50" class="slider" id="slider1">
  </div>
</main>

<script src="https://unpkg.com/tone"></script>

<script>
let tempo = 120;
let beat_length = 500;
let bar_length = 60 / tempo * 1000 * 4;
</script>

<!-- <script src='scripts/tone.js'></script> -->
<!-- <script src='scripts/web-audio.js'></script> -->

<script>

let connecting = null;

const grid = document.querySelector('#the-grid');
const digits = ['A', 'B', 'C', 'D', 'E', '!', '?', 'O', '0', '-',]
const note_string = '-CDEFGABC+'
const polyrhythm_string = '0123456789'
const digit_string = 'QWERTYUIOP{}[]ASDFGHJKL:;|\'"`~ZXCVBNM<>?/,.1234567890-=!@£$%^&*()_+±§';

const select = (target) => {
  // if (target.hue === undefined || target.hue === 360) {
  //   target.hue = 0;
  // }
  console.log(target)
  if (connecting === null) {
    connecting = target
  } else {
    connecting.connectTo(target);
  }
  // target.style.color = `hsl(${target.hue},75%,50%)`;
  // target.hue += 20;
  target.dom.classList.add('selected');
}

const createDomWire = (from, to) => {
  console.log(
    Array.from(from.parentNode.children).indexOf(from),
    Array.from(from.parentNode.parentNode.children).indexOf(from.parentNode),
    ' to ',
    Array.from(to.parentNode.children).indexOf(to),
    Array.from(to.parentNode.parentNode.children).indexOf(to.parentNode)
  )
  let from_col = Array.from(from.parentNode.children).indexOf(from),
      from_row = Array.from(from.parentNode.parentNode.children).indexOf(from.parentNode),
      to_col = Array.from(to.parentNode.children).indexOf(to),
      to_row = Array.from(to.parentNode.parentNode.children).indexOf(to.parentNode);
  // console.log('from',from.parentNode.children)


  // 2 options - vertical adjacent, horizontal adjacent
  // 2 options - same row but seperated, same col but seperated
  // 2 options - different row but 1 col apart, different col but 1 row apart
  // 1 option / 4 directions - row and col both 1 apart

  const addWireSection = (type, direction, length) => {
    if (x === undefined && y === undefined) {
      switch (direction) {
        case 'right':
        x = from.offsetLeft + from.offsetWidth + 2;
        y = from.offsetTop + (from.offsetHeight/2) - 1;
        break;
        case 'left':
        x = from.offsetLeft;
        y = from.offsetTop + (from.offsetHeight/2) - 1;
        break;
      }
    }

    let wire_dom = document.createElement('div');
    wire_dom.classList.add('wire');
    wire_dom.style.backgroundColor = 'red';

    // wire_dom.style.width = to.offsetLeft - from.offsetLeft - to.offsetWidth + 'px';
    let xx = 0;
    let yy = 0;
    if (type === 'nub') {
      xx = 2;
      yy = 2;
    } else if (type === 'vertical') {
      xx = 2;
      yy = length;
    } else if (type === 'horizontal') {
      xx = length;
      yy = 2;
    }
    wire_dom.style.left = (direction === 'left' ? x-xx -2 : x) + 'px';
    wire_dom.style.top = (direction === 'up' ? y-yy -2 : y) + 'px';

    wire_dom.style.width = xx + 'px';
    wire_dom.style.height = yy + 'px';
    x += direction === 'left' ? -xx - 4 : xx;
    y += direction === 'up' ? -yy - 4 : yy;
    grid.appendChild(wire_dom)
  }

  let x, y;




  if (to_col === from_col+1 && to_row === from_row) { //
    addWireSection('horizontal', 'right', 6)
  } else if (to_col === from_col-1 && to_row === from_row) { //
    addWireSection('horizontal', 'left', 6)
  } else if (to_col === from_col+1 && to_row !== from_row) {
    addWireSection('nub', 'right');
    addWireSection('vertical',
      to_row > from_row ? 'down' : 'up',
      to_row > from_row ? (to.offsetTop - from.offsetTop - 2) : (from.offsetTop - to.offsetTop - 2));
    addWireSection('nub', 'right');
  } else if (to_col === from_col-1 && to_row !== from_row) {
    addWireSection('nub', 'left');
    addWireSection('vertical',
      to_row > from_row ? 'down' : 'up',
      to_row > from_row ? (to.offsetTop - from.offsetTop - 2) : (from.offsetTop - to.offsetTop - 2));
    addWireSection('nub', 'left');
  }





  // wire_dom.style.backgroundColor = `hsl(${hue},75%,50%)`;
  // wire_dom.style.backgroundColor = 'red';
  // wire_dom.style.left = from.offsetLeft + from.offsetWidth + 'px';
  // wire_dom.style.top = `${from.offsetTop + ((to.offsetTop - from.offsetTop) / 2) + (to.offsetHeight / 2)}px`;
  // wire_dom.style.width = to.offsetLeft - from.offsetLeft - to.offsetWidth + 'px';
  // wire_dom.style.transform = 'skewY(45deg)';
  // console.log(from.offsetLeft, from.offsetWidth)
  // grid.appendChild(wire_dom)
}

const Node = (dom) => {
  let hue = 0;
  let connected_to = [];
  const log = () => {
    console.log(dom.innerHTML)
  }
  const connectTo = (target) => {

    connected_to.push(target);
    let wire_dom = createDomWire(dom, target.dom);

  }
  const click = () => {
    synth.triggerAttackRelease(`${dom.innerHTML}3`, '8n')
    dom.style.color = `hsl(${hue},75%,50%)`;
    dom.classList.add('selected');
    console.log(dom.innerHTML, hue)
    hue += 20;
  }
  const start_connection = () => {
    dom.style.color = `hsl(${hue},75%,50%)`;
    dom.classList.add('selected');
    console.log(dom.innerHTML, hue, event.target)
    hue += 20;
  }
  // dom.addEventListener('click', start_connection)
  return {log, dom, connectTo, connected_to}
}

const node_objects = [];

for (y = 0; y < 10; y++) {
  let row = document.createElement('div');
  row.classList.add('row');
  grid.appendChild(row);
  for (x = 0; x < 10; x++) {
    let node = document.createElement('span');
    node.classList.add('node');
    if (y < 8 && y % 2 === 1) {
      node.innerHTML = note_string.substr(x, 1);
    } else if (y === 0) {
      node.innerHTML = polyrhythm_string.substr(x, 1);
    } else {
      node.innerHTML = digit_string.substr(Math.floor(Math.random()*digit_string.length),1);
    }
    // node.addEventListener('click', (()=>{select(event.target)}))
    // node_objects.push(Node(node));
    let node_object = Node(node);
    node_objects.push(node_object);
    node.addEventListener('click', (()=>{select(node_object)}))

    row.appendChild(node);
  }
}

const nodes = document.querySelectorAll('.node');

// nodes[15].classList.add('spin_anim')

const theGrid = (() => {

})


console.log(grid)

// let spin_repeat = setInterval(()=>{
//   // let nodes = node_objects;
//   let random_node = nodes[Math.floor(Math.random()*nodes.length)];
//   if (random_node.classList.contains('spin_anim')) {
//     random_node.classList.remove('spin_anim')
//   }
//   // console.log(random_node)
//   random_node.classList.add('spin_anim')
// }, 2000);


</script>


</body>
</html>
